# 服务器部署快速指南

## 问题：manifest unknown 错误

当看到 `Error response from daemon: manifest unknown` 时，说明 Docker 尝试从远程仓库拉取镜像失败。

## 解决方案

### 方法 1: 使用修复脚本（推荐）

```bash
# 1. 将镜像文件和修复脚本传输到服务器
scp aipyq-latest-amd64.tar fix-server-deploy.sh user@server:/opt/aipyq/

# 2. SSH 登录服务器
ssh user@server
cd /opt/aipyq

# 3. 运行修复脚本
chmod +x fix-server-deploy.sh
./fix-server-deploy.sh

# 4. 启动服务
docker compose up -d
```

### 方法 2: 手动修复

```bash
# 1. 加载镜像
docker load -i aipyq-latest-amd64.tar

# 2. 验证镜像已加载
docker images | grep aipyq

# 3. 修改 docker-compose.yml，将镜像名称改为：
#    image: aipyq:latest
#    而不是使用环境变量

# 4. 或者设置环境变量（如果使用 docker-compose.yml）
export IMAGE_PREFIX=aipyq
export IMAGE_TAG=latest
export DOCKER_REGISTRY=
export DOCKER_REGISTRY_USER=

# 5. 启动服务
docker compose up -d
```

### 方法 3: 使用 deploy-compose.yml（最简单）

```bash
# 1. 加载镜像
docker load -i aipyq-latest-amd64.tar

# 2. 使用 deploy-compose.yml（已经配置为使用 aipyq:latest）
docker compose -f deploy-compose.yml up -d
```

## 完整部署步骤

```bash
# 1. 在服务器上创建目录
mkdir -p /opt/aipyq
cd /opt/aipyq

# 2. 从本地传输文件
# 在本地执行：
scp aipyq-latest-amd64.tar user@server:/opt/aipyq/
scp Aipyq.yaml user@server:/opt/aipyq/
scp deploy-compose.yml user@server:/opt/aipyq/
scp fix-server-deploy.sh user@server:/opt/aipyq/

# 3. 在服务器上执行
cd /opt/aipyq

# 加载镜像
docker load -i aipyq-latest-amd64.tar

# 创建必要的目录
mkdir -p images uploads logs data-node meili_data_v1.12

# 创建 .env 文件（如果不存在）
cat > .env << 'EOF'
MONGO_PORT=27017
MEILI_PORT=7700
MEILI_MASTER_KEY=your-master-key-here
API_PORT=3080
EOF

# 使用 deploy-compose.yml 启动（推荐）
docker compose -f deploy-compose.yml up -d

# 或者使用修复后的 docker-compose.yml
docker compose up -d
```

## 验证部署

```bash
# 查看容器状态
docker compose ps

# 查看日志
docker compose logs -f api

# 测试 API
curl http://localhost:3080/api/health
```

## 常见问题

### Q: 镜像加载后仍然报错
A: 检查镜像名称是否正确：
```bash
docker images | grep aipyq
# 应该看到 aipyq:latest
```

### Q: 容器无法启动
A: 检查日志：
```bash
docker compose logs api
```

### Q: 端口被占用
A: 检查端口占用：
```bash
netstat -tulpn | grep 3080
```

### Q: 需要更新镜像
A: 
```bash
# 加载新镜像
docker load -i aipyq-latest-amd64.tar

# 重启服务
docker compose up -d --force-recreate api
```

