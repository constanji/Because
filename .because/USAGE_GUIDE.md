# BeCause 智能问数工具系统使用指南

## 快速开始

### 方式一：通过智能体命令使用（推荐）

如果你使用的是集成了 BeCause 工具的智能体系统，可以直接使用命令：

```
/because.generate_sql 查询每个国家的病例总数
```

或者更具体地：

```
用户查询：查询每个国家的病例总数
语义模型：[语义模型内容]
```

智能体会：
1. 自动识别这是 SQL 生成需求
2. 选择 SQL 生成命令模板
3. 提取关键信息（查询、语义模型等）
4. 替换所有变量占位符
5. 生成 ANSI SQL 查询

### 方式二：手动使用模板

如果你想手动使用模板，可以按照以下步骤：

## 详细使用流程

### 第一步：选择命令

根据你要执行的智能问数任务类型，选择合适的命令模板：

| 任务类型 | 命令文件 | 适用情况 |
|---------|---------|---------|
| SQL 生成 | `commands/generate-sql.md` | 将自然语言转换为 SQL |
| 意图分类 | `commands/classify-intent.md` | 分类用户查询意图 |
| 数据辅助 | `commands/assist-data.md` | 回答数据库模式问题 |
| 误导查询处理 | `commands/handle-misleading.md` | 处理误导性查询 |
| 推理生成 | `commands/generate-reasoning.md` | 生成 SQL 推理计划 |

### 第二步：阅读命令模板

打开选中的命令文件，了解命令的执行流程：

1. **执行步骤**：命令模板定义了详细的执行步骤
2. **变量要求**：命令模板列出了所需的变量
3. **模板路径**：指示了需要使用的提示词模板路径
4. **输出格式**：说明了预期的输出格式

### 第三步：准备变量数据

根据命令模板要求，准备以下信息：

#### 必需变量
- **query**：用户查询问题
- **query_time**：当前系统时间
- **semantic_models**：语义模型列表
- **language**：输出语言

#### 可选变量
- **instruction**：用户自定义指令
- **text_to_sql_rules**：SQL 生成规则
- **data_samples**：数据样本
- **sql_samples**：SQL 示例
- **synonyms**：同义词列表
- **docs**：业务知识文档
- **histories**：查询历史

### 第四步：加载提示词模板

根据命令模板中的路径，加载对应的提示词模板：

1. **System Prompt**：系统提示词模板
2. **User Prompt Template**：用户提示词模板

提示词模板文件位于：
- 默认模式：`templates/prompt-templates/default/`
- Agentic 模式：`templates/prompt-templates/agentic/`

### 第五步：执行变量替换

使用 Jinja2 模板引擎替换模板中的变量：

1. **替换必需变量**：确保所有必需变量都已替换
2. **条件替换可选变量**：根据实际情况决定是否使用可选变量
3. **验证替换结果**：检查是否还有未替换的变量

### 第六步：调用 LLM

使用替换后的提示词调用 LLM：

1. **构建消息**：
   - System Message：使用替换后的 System Prompt
   - User Message：使用替换后的 User Prompt Template

2. **发送请求**：
   - 调用 LLM API
   - 传递 System Message 和 User Message
   - 设置适当的参数

3. **获取响应**：
   - 接收 LLM 的响应
   - 解析响应内容

### 第七步：处理响应

根据命令模板要求处理 LLM 响应：

1. **验证格式**：检查响应格式是否符合要求
2. **提取结果**：从响应中提取所需信息
3. **验证内容**：检查内容的正确性和完整性

### 第八步：返回结果

返回处理后的结果，包括：
- 主要结果（SQL、意图分类等）
- 相关元数据
- 错误信息（如果有）

## 实际使用示例

### 示例1：SQL 生成

**用户输入**：
```
查询每个国家的病例总数
```

**使用流程**：
1. 选择命令：`generate-sql.md`（SQL 生成）
2. 准备变量：
   - query: "查询每个国家的病例总数"
   - semantic_models: [语义模型内容]
   - query_time: "2025-01-27 10:30:00"
   - language: "简体中文"
3. 加载模板：SQL 生成的系统提示和用户提示模板
4. 替换变量：使用 Jinja2 替换所有变量
5. 调用 LLM：发送提示词并获取响应
6. 处理响应：解析 JSON，提取 SQL

**生成结果示例**：
```json
{
    "sql": "SELECT country, SUM(cases) as total_cases FROM covid_data GROUP BY country"
}
```

### 示例2：意图分类

**用户输入**：
```
查询每个国家的病例总数
```

**使用流程**：
1. 选择命令：`classify-intent.md`（意图分类）
2. 准备变量：
   - query: "查询每个国家的病例总数"
   - query_time: "2025-01-27 10:30:00"
   - language: "简体中文"
3. 加载模板：意图分类的系统提示和用户提示模板
4. 替换变量：使用 Jinja2 替换所有变量
5. 调用 LLM：发送提示词并获取响应
6. 处理响应：解析 JSON，提取意图分类

**生成结果示例**：
```json
{
    "rephrased_question": "查询每个国家的病例总数",
    "reasoning": "查询涉及数据库表和列，需要生成SQL",
    "intent": "TEXT_TO_SQL"
}
```

### 示例3：数据辅助

**用户输入**：
```
这个数据集是关于什么的？
```

**使用流程**：
1. 选择命令：`assist-data.md`（数据辅助）
2. 准备变量：
   - query: "这个数据集是关于什么的？"
   - semantic_models: [语义模型内容]
   - language: "简体中文"
3. 加载模板：数据辅助的系统提示和用户提示模板
4. 替换变量：使用 Jinja2 替换所有变量
5. 调用 LLM：发送提示词并获取响应
6. 处理响应：提取 Markdown 格式的回答

**生成结果示例**：
```markdown
这个数据集包含全球 COVID-19 病例信息，包括：
- 国家/地区名称
- 病例数量
- 日期信息

数据集可用于分析不同地区的疫情趋势...
```

## 变量参考

如果需要了解所有可用变量，请查看：
- `templates/variable-system/variable-reference.md` - 变量参考手册
- `templates/variable-system/variable-examples.md` - 变量使用示例

## 常见问题

### Q1: 如何选择合适的命令？

**A**: 根据你要执行的任务类型选择：
- 需要生成 SQL → SQL 生成命令
- 需要分类查询意图 → 意图分类命令
- 需要回答数据库问题 → 数据辅助命令
- 需要处理误导查询 → 误导查询处理命令
- 需要生成推理计划 → 推理生成命令

### Q2: 变量替换后模板不正确怎么办？

**A**: 
1. 检查变量值是否准确
2. 检查变量类型是否正确
3. 检查模板语法是否正确
4. 参考变量示例手册

### Q3: LLM 响应格式错误怎么办？

**A**: 
1. 检查提示词模板是否正确
2. 检查变量替换是否完整
3. 尝试解析响应中的 JSON 部分
4. 重新请求或调整提示词

### Q4: 如何自定义提示词模板？

**A**: 
1. 复制现有模板文件
2. 根据需求修改内容
3. 调整变量定义
4. 保存为新模板

### Q5: 生成的 SQL 可以直接使用吗？

**A**: 建议：
1. 检查 SQL 语法是否正确
2. 检查是否使用了正确的表和列
3. 检查是否符合 ANSI SQL 标准
4. 测试执行以确保正确性

## 高级用法

### 批量处理

如果有多个查询需要处理，可以：
1. 准备一个查询列表
2. 循环执行命令模板
3. 批量生成 SQL 或分类结果

### 命令组合

对于复杂场景，可以：
1. 先执行意图分类命令
2. 根据分类结果选择相应的处理命令
3. 组合多个命令的结果

### 自定义变量

根据项目需求，可以：
1. 添加自定义变量
2. 修改变量替换逻辑
3. 扩展模板功能

## 最佳实践

1. **准确性**：确保生成的 SQL 语法正确
2. **标准性**：使用 ANSI SQL 标准
3. **安全性**：避免 SQL 注入风险
4. **性能**：考虑查询性能优化
5. **可维护性**：保持模板和变量清晰易懂

## 获取帮助

如果遇到问题，可以：
1. 查看 README.md 了解系统概述
2. 查看各命令文件中的说明
3. 参考变量参考手册
4. 查看格式规范指南

---

**最后更新**：2025-01-27  
**版本**：1.0.0
